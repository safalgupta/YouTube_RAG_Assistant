<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>YouTube Video Q&A</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Inter", sans-serif;
      }
      .chat-bubble {
        max-width: 75%;
        padding: 10px 15px;
        border-radius: 20px;
        word-wrap: break-word;
      }
      .user-bubble {
        background-color: #3b82f6; /* blue-500 */
        color: white;
        align-self: flex-end;
        border-bottom-right-radius: 5px;
      }
      .bot-bubble {
        background-color: #e5e7eb; /* gray-200 */
        color: #1f2937; /* gray-800 */
        align-self: flex-start;
        border-bottom-left-radius: 5px;
      }
      .loader {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #3b82f6;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>
  <body
    class="bg-gray-100 flex flex-col items-center justify-center min-h-screen p-4"
  >
    <div
      class="w-full max-w-2xl bg-white rounded-2xl shadow-xl p-6 md:p-8 space-y-6"
    >
      <div class="text-center">
        <h1 class="text-3xl font-bold text-gray-800">YouTube Video Q&A</h1>
        <p class="text-gray-500 mt-2">
          Enter a YouTube video URL to start asking questions about its content.
        </p>
      </div>

      <!-- URL Input Section -->
      <div id="url-section" class="space-y-4">
        <div>
          <label
            for="youtube-url"
            class="block text-sm font-medium text-gray-700 mb-1"
            >YouTube URL</label
          >
          <input
            type="text"
            id="youtube-url"
            placeholder="e.g., https://www.youtube.com/watch?v=dQw4w9WgXcQ"
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition"
          />
        </div>
        <button
          id="process-btn"
          class="w-full bg-blue-600 text-white font-semibold py-2.5 px-4 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-300 ease-in-out flex items-center justify-center space-x-2"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-5 w-5"
            viewBox="0 0 20 20"
            fill="currentColor"
          >
            <path
              d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.428A1 1 0 0010 16h.008a1 1 0 00.724-.31l5-6a1 1 0 00.276-1.243l-4-10z"
            />
          </svg>
          <span>Process Video</span>
        </button>
        <div
          id="status-message"
          class="text-center text-sm text-gray-600 min-h-[20px]"
        ></div>
      </div>

      <!-- Q&A Section -->
      <div id="qa-section" class="hidden">
        <p class="text-center text-sm text-gray-600 mb-4">
          Video processed! You can now ask questions.
        </p>
        <div
          id="chat-container"
          class="h-80 overflow-y-auto bg-gray-50 p-4 rounded-lg border border-gray-200 flex flex-col space-y-4 mb-4"
        >
          <!-- Chat messages will be appended here -->
        </div>
        <div class="flex space-x-2">
          <input
            type="text"
            id="question-input"
            placeholder="Ask a question..."
            class="flex-grow px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition"
          />
          <button
            id="ask-btn"
            class="bg-blue-600 text-white font-semibold p-2 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition flex items-center justify-center w-12 h-10"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-6 w-6"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M13 5l7 7-7 7M5 5l7 7-7 7"
              />
            </svg>
          </button>
        </div>
      </div>
    </div>

    <script>
      const urlSection = document.getElementById("url-section");
      const qaSection = document.getElementById("qa-section");
      const processBtn = document.getElementById("process-btn");
      const askBtn = document.getElementById("ask-btn");
      const urlInput = document.getElementById("youtube-url");
      const questionInput = document.getElementById("question-input");
      const statusMessage = document.getElementById("status-message");
      const chatContainer = document.getElementById("chat-container");

      const API_BASE_URL = "http://127.0.0.1:5000";
      let currentVideoId = null;

      function showLoader(button) {
        button.disabled = true;
        button.innerHTML = `<div class="loader"></div>`;
      }

      function hideLoader(button, originalContent) {
        button.disabled = false;
        button.innerHTML = originalContent;
      }

      function addMessage(text, sender) {
        const bubble = document.createElement("div");
        bubble.classList.add(
          "chat-bubble",
          sender === "user" ? "user-bubble" : "bot-bubble"
        );
        bubble.textContent = text;
        chatContainer.appendChild(bubble);
        chatContainer.scrollTop = chatContainer.scrollHeight;
      }

      async function processVideo() {
        const videoUrl = urlInput.value.trim();
        if (!videoUrl) {
          statusMessage.textContent = "Please enter a YouTube URL.";
          statusMessage.classList.add("text-red-500");
          return;
        }

        statusMessage.textContent =
          "Processing video... this may take a moment.";
        statusMessage.classList.remove("text-red-500", "text-green-500");
        const originalBtnContent = processBtn.innerHTML;
        showLoader(processBtn);

        try {
          const response = await fetch(`${API_BASE_URL}/process`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ video_url: videoUrl }),
          });

          const data = await response.json();

          if (!response.ok) {
            throw new Error(data.error || "Failed to process video.");
          }

          currentVideoId = data.video_id;
          statusMessage.textContent = data.message;
          statusMessage.classList.add("text-green-500");

          setTimeout(() => {
            urlSection.classList.add("hidden");
            qaSection.classList.remove("hidden");
          }, 1000);
        } catch (error) {
          statusMessage.textContent = `Error: ${error.message}`;
          statusMessage.classList.add("text-red-500");
        } finally {
          hideLoader(processBtn, originalBtnContent);
        }
      }

      async function askQuestion() {
        const question = questionInput.value.trim();
        if (!question || !currentVideoId) return;

        addMessage(question, "user");
        questionInput.value = "";

        const originalBtnContent = askBtn.innerHTML;
        showLoader(askBtn);

        try {
          const response = await fetch(`${API_BASE_URL}/ask`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              question: question,
              video_id: currentVideoId,
            }),
          });

          const data = await response.json();

          if (!response.ok) {
            throw new Error(data.error || "Failed to get an answer.");
          }

          addMessage(data.answer, "bot");
        } catch (error) {
          addMessage(`Sorry, something went wrong: ${error.message}`, "bot");
        } finally {
          hideLoader(askBtn, originalBtnContent);
        }
      }

      processBtn.addEventListener("click", processVideo);
      askBtn.addEventListener("click", askQuestion);
      questionInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter") {
          askQuestion();
        }
      });
      urlInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter") {
          processVideo();
        }
      });
    </script>
  </body>
</html>
